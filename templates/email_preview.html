<!DOCTYPE html>
<html>
<head>
    <title>Email Preview</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { background: #e5e5e5; font-family: Arial; color: #000042; }
        .container { max-width: 600px; margin: 30px auto; background: #fff; border-radius: 12px; padding: 28px; }
        .subject { font-weight: bold; margin-bottom: 18px; }
        .body { margin-bottom: 22px; }
        .btn { background: #9E2328; color: white; border: none; padding: 8px 22px; border-radius: 8px; cursor: pointer; }
        .chart { width: 100%; height: 400px; margin: 20px 0; }
        .status { margin: 20px 0; font-weight: bold; }
        .sent { color: green; }
        .failed { color: red; }
    </style>
</head>
<body>
    <div class="container">
    <a href="{{ url_for('dashboard') }}" style="text-decoration:none;">
        <button style="background:transparent; border:none; padding:4px 10px; cursor:pointer; margin-bottom:16px;">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="26" y1="16" x2="8" y2="16" stroke="#000042" stroke-width="4" stroke-linecap="round"/>
                <polyline points="14,10 8,16 14,22" fill="none" stroke="#000042" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </a>
        <div class="subject">{{ subject }}</div>
        <div class="body">{{ body }}</div>
        {% if chart_data and chart_data["timestamp"] %}
        <div id="email_chart" class="chart"></div>
        <script>
            var traceA = {
                x: {{ chart_data["timestamp"] }},
                y: {{ chart_data["pressure_a"] }},
                mode: 'lines',
                name: 'Pressure A',
                line: {color: '#9E2328'}
            };
            var traceB = {
                x: {{ chart_data["timestamp"] }},
                y: {{ chart_data["pressure_b"] }},
                mode: 'lines',
                name: 'Pressure B',
                line: {color: '#000042'}
            };
            var layout = {
                title: {text: 'Test Results Chart', x:0.5},
                xaxis: {title: 'Time (s)', dtick: 5},
                yaxis: {title: 'Pressure (psi)', range: [0, 120], dtick: 10}
            };
            Plotly.newPlot('email_chart', [traceA, traceB], layout, {responsive: true});
        </script>
        {% endif %}
                <button class="btn" id="send-email-btn">Send Email</button>
                <div id="email-status" class="status"></div>
                <script>
                document.getElementById('send-email-btn').onclick = function() {
                        fetch('/send_email/{{ request.view_args["order_id"] }}', {method: 'POST'})
                            .then(response => response.json())
                            .then(data => {
                                var statusDiv = document.getElementById('email-status');
                                if (data.status) {
                                    statusDiv.textContent = data.status;
                                    statusDiv.className = 'status sent';
                                } else {
                                    statusDiv.textContent = data.error || 'Error sending email.';
                                    statusDiv.className = 'status failed';
                                }
                            })
                            .catch(err => {
                                var statusDiv = document.getElementById('email-status');
                                statusDiv.textContent = 'Error: ' + err;
                                statusDiv.className = 'status failed';
                            });
                };
                </script>
    </div>
</body>
</html>