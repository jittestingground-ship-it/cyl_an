<!DOCTYPE html>
<html>
<head>
    <title>Order Details</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/details.css') }}">
</head>
<body>
    <div class="container">
        <div class="tables">
                        <button id="capture-report-btn" style="background:#2E7D32; color:#fff; border:none; border-radius:6px; padding:8px 24px; font-size:1.1em; font-weight:bold; margin-bottom:8px; margin-top:8px; cursor:pointer;">
                                Capture Report & Preview Email
                        </button>
                        <script>
                        document.getElementById('capture-report-btn').onclick = function() {
                            fetch('/trigger_capture_report/{{ order[1] }}', {method: 'POST'})
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status) {
                                        alert('Report captured and saved successfully.');
                                    } else {
                                        alert(data.error || 'Error capturing report.');
                                    }
                                })
                                .catch(err => alert('Error: ' + err));
                        };
                        </script>
            <a href="{{ url_for('report', order_id=order[1]) }}" style="text-decoration:none;">
                <button style="background:#9E2328; color:#000042; border:none; border-radius:6px; padding:8px 24px; font-size:1.1em; font-weight:bold; margin-bottom:16px; margin-top:8px; cursor:pointer;">
                    View Order Report
                </button>
            </a>
            <a href="{{ url_for('dashboard') }}" style="text-decoration:none;">
                <button style="background:transparent; border:none; padding:4px 10px; cursor:pointer; margin-bottom:8px;">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="26" y1="16" x2="8" y2="16" stroke="#000042" stroke-width="4" stroke-linecap="round"/>
                        <polyline points="14,10 8,16 14,22" fill="none" stroke="#000042" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </a>
            <div class="table-title">ORDER INFO</div>
            <ul class="order-list">
                <li>
                    <span class="list-label">Order ID:</span>
                    <span class="list-value">{{ order[1] }}</span>
                </li>
                <li>
                    <span class="list-label">Name:</span>
                    <span class="list-value">{{ order[2] }}</span>
                </li>
                <li>
                    <span class="list-label">Email:</span>
                    <span class="list-value">{{ order[3] }}</span>
                </li>
                <li>
                    <span class="list-label">Phone:</span>
                    <span class="list-value">{{ order[4] }}</span>
                </li>
                <li>
                    <span class="list-label">Address:</span>
                    <span class="list-value">{{ order[5] }}</span>
                </li>
            </ul>
            <div class="table-title">TEST RESULTS</div>
            <ul class="test-list">
                {% if meta.get('message') %}
                <li><span class="list-label">{{ meta['message'] }}</span></li>
                <li><span class="list-label">Scan barcode to run test</span></li>
                {% else %}
                <li>
                    <span class="list-label">Set Pressure:</span>
                    <span class="list-value">{{ meta['set_pressure'] }}</span>
                </li>
                <li>
                    <span class="list-label">Avg Pressure A:</span>
                    <span class="list-value">{{ meta['avg_pressure_a'] }}</span>
                </li>
                <li>
                    <span class="list-label">Avg Pressure B:</span>
                    <span class="list-value">{{ meta['avg_pressure_b'] }}</span>
                </li>
                <li>
                    <span class="list-label">Max Leak Pressure:</span>
                    <span class="list-value">{{ meta['max_leak_pressure'] }}</span>
                </li>
                <li>
                    <span class="list-label">Cycle Count:</span>
                    <span class="list-value">{{ meta['cycle_count'] }}</span>
                </li>
                <li>
                    <span class="list-label">Test Time:</span>
                    <span class="list-value">{{ meta['test_time'] }}</span>
                </li>
                <li>
                    <span class="list-label">Samples:</span>
                    <span class="list-value">{{ meta['samples'] }}</span>
                </li>
                <li>
                    <span class="list-label">Test Pass/Fail:</span>
                    <span class="list-value">{{ meta['test_pass_fail'] }}</span>
                </li>
                {# Removed Saved At row #}
                {% endif %}
            </ul>
        </div>
        <div class="chart">
            {% if chart_data["timestamp"] %}
            <div id="pressure_chart"></div>
            <script>
                var traceA = {
                    x: JSON.parse('{{ chart_data["timestamp"] | tojson | safe }}'),
                    y: JSON.parse('{{ chart_data["pressure_a"] | tojson | safe }}'),
                    mode: 'lines',
                    name: 'Pressure A',
                    line: {color: '#9E2328', width: 4}
                };
                var traceB = {
                    x: JSON.parse('{{ chart_data["timestamp"] | tojson | safe }}'),
                    y: JSON.parse('{{ chart_data["pressure_b"] | tojson | safe }}'),
                    mode: 'lines',
                    name: 'Pressure B',
                    line: {color: '#000042', width: 4}
                };
                var layout = {
                    title: {
                        margin: { l: 40, r: 10, t: 60, b: 40 },
                        text: 'Pressure vs Time',
                        x: 0.5,
                        y: 0.99,
                        font: {
                            size: 28,
                            color: '#000042',
                            family: 'Arial',
                            weight: 'bold'
                        }
                    },
                    xaxis: {
                        title: {text: 'Time (s)', standoff: 40, font: {color: '#000042', size: 20,family: 'Arial', weight: 'bold'}},
                        range: [0, 70], dtick: 5, gridcolor: 'white',
                        tickfont: {color: '#000042', size: 14, family: 'Arial'},
                        ticks: 'outside',
                        showline: true,
                        linewidth: 2,
                        linecolor: '#000042'
                    },
                    yaxis: {
                        title: {text: 'Pressure (psi)', standoff: 40, font: {color: '#000042', size: 20, family: 'Arial', weight: 'bold'}},
                        range: [0, 120], dtick: 10, gridcolor: 'white',
                        tickfont: {color: '#000042', size: 14, family: 'Arial'},
                        ticks: 'outside',
                        showline: true,
                        linewidth: 2,
                        linecolor: '#000042'
                    },
                    margin: { l: 60, r: 10, t: 60, b: 40 },
                    plot_bgcolor: '#e5e5e5',
                    legend: {
                        bgcolor: 'rgba(0, 0, 0, 0)',
                        orientation: 'v',
                        x: .15,
                        y: -0.35,
                        xanchor: 'left',
                        yanchor: 'bottom',
                        font: {
                            size: 10
                        
                        }   

            
                    },
                    width: undefined
                };
                Plotly.newPlot('pressure_chart', [traceA, traceB], layout, {responsive: true});
            </script>
            {% else %}
            <div style="text-align: center; padding: 100px; color: #000042; font-size: 18px;">
                <h3>No Test Data Available</h3>
                <p>Use barcode scanner to run test for this order</p>
            </div>
            {% endif %}
        </div>
    </div>
</body>
</html>